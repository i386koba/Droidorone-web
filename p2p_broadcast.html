<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.

From  https://github.com/nttcom/SkyWay-JS-Sample/tree/master/p2p_broadcast
-->

<html>
<head>
  <meta charset="utf-8">
  <title>SkyWay - Broadcast example</title>
  <!--link rel="stylesheet" href="style.css"-->
  <script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script>
  <script type="text/javascript" src="https://skyway.io/dist/0.3/peer.js"></script>
  <!--<script type="text/javascript" src="https://cdn.skyway.io/skyway.js"></script>-->
  <script>
    // Compatibility shim
    navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
    // Peer object
    var peer = new Peer({
      key: '30fa6fbf-0cce-45c1-9ef6-2b6191881109',
      debug: 3
    });
    peer.on('open', function(){
      $('#my-id').text(peer.id);
    });
    // Receiving a call
    peer.on('call', function(call){
      // Answer the call automatically (instead of prompting user) for demo purposes
      call.answer(window.localStream);
    });
    peer.on('error', function(err){
      alert(err.message);
    });
    // Click handlers setup
    $(function(){
      $('#broadcast').submit(function(e){
        e.preventDefault();
        navigator.getUserMedia({audio: true, video: true}, function(stream){
            var url = window.URL.createObjectURL(stream);
            //test
            $('#url').text(url);
            $('#video-ref').attr("href", "video-bc.html?" + encodeURIComponent(url));
            // Set your video displays
            $('#video').prop('src', url).prop('muted', true);
            window.localStream = stream;
        }, function(){ $('#step1-error').show(); });
      });
      $('#watch').submit(function(e){
        e.preventDefault();
        // Initiate a call!
        console.log($('#callto-id').val());
        var call = peer.call($('#callto-id').val());
        showBroadcast(call);
      });
    });
    function showBroadcast (call) {
      // Wait for stream on the call, then set peer video display
      call.on('stream', function(stream){
        $('#video').prop('src', URL.createObjectURL(stream));
      });
      call.on('close', function() {
        console.log('connection closed');
      });
    }
  </script>


</head>

<body>

<div>

  <!-- Video area -->
  <div id="video-container">
    <video id="video" autoplay></video>
  </div>

  <a id="video-ref" target="_blank">video-bc</a>
  <p>stream URL <span id="url">...</span></p>
  
  <!-- Steps -->
  <div >
    <h2>SkyWay Video BroadCast (P2P)</h2>

    <!-- Get local audio/video stream -->
    <div id="step1">
      <p>Your id: <span id="my-id">...</span></p>
      <p>If you are broadcaster, just click Broadcast button and wait for participants.</p>
      <form id="broadcast">
        <button	type="submit">Broadcast</button>
      </form>
      <p>If you want to watch broadcasting, enter broadcaster's peer ID and click Watch button.</p>
      <form id="watch">
        <input type="text" placeholder="Call user id..." id="callto-id">
        <button type="submit">Watch</button>
      </form>
    </div>

  </div>
</div>


</body>
</html>